---
title: 웹 애플리케이션이나 사이트를 만들 때 고려해야 할 Performance
date: 2020-07-18 10:07:93
category: frontend
draft: true
---

## 성능 최적화에 필요한 이론과 측정 도구

- Ajax 통신, 복잡한 UI 등 많은 기능을 담으면서 크고 무거워졌습니다. 무거워진 웹은 긴 로딩 시간 함께 사용자 경험에 안 좋은 영향을 끼칩니다. 긴 로딩 시간은 사용자가 페이지를 나가는 비율이 높입니다. Performance 매출 실적과 연결될 정도로 웹 애플리케이션의 성능 최적화는 매우 중요합니다.

### 브라우저의 로딩 과정

- 브라우저는 웹 페이지에 필요한 리소스를 내려받고 해석한 다음 여러 계산 과정을 거쳐 콘텐츠를 화면에 보여줍니다. 이를 브라우저의 로딩 과정이라고 하며 다운로드, 파싱, 스타일, 레이아웃, 페인트, 합성으로 나뉩니다.

#### 1. 파싱

- 브라우저에서 웹 페이지를 로드하면 가장 먼저 HTML 파일을 다운로드합니다. 파싱은 다운로드한 HTML을 해석하여 DOM 트리를 구성하는 단계입니다. 파싱 중 \<script />, \<link />, \<img />를 발견하면 각 리소스를 요청하고 다운로드합니다. HTML 또는 리소스에 CSS가 포함된 경우에는 CSSOM 트리 구성 작업도 함께 진행합니다.
- DOM 트리 구성 : 파싱이 일어나면 HTML을 해석해 DOM을 생성한 후, 각 DOM 객체를 트리 데이터 구조로 연결해 부모-자식 관계를 갖도록 만듭니다. \<body>, \<p>, \<div> 등 각 태그가 DOM 트리의 노드로 생성되고 자식 노드를 참조합니다.
- CSSOM 트리 구성 : style.css처럼 외부 스타일시트 파일이나 내부 스타일시트가 포함되어 있을 경우, CSS를 해석해 CSSOM 트리를 구성합니다. body, p, span 등 선택자가 노드로 생성되고 각 노드는 스타일을 참조합니다.

#### 2. 스타일

- 스타일 단계에서는 파싱 단계에서 생성된 DOM, CSSOM 트리를 가지고 스타일을 매칭시켜주는 과정을 거쳐 렌더 트리를 구성합니다.

#### 3. 레이아웃

- 레이아웃 단계에서는 노드의 정확한 위치와 크기를 계산합니다. 노드의 정확한 크기와 위치를 파악하기 위해 루트부터 노드를 순회하면서 계산하고, 레이아웃 결과로 각 노드의 정확한 위치와 크기를 픽셀값으로 렌더트리에 반영합니다. 만약 CSS에서 크기 값을 %(퍼센트)로 지정하였다면, 레이아웃 단계를 거친 후 %(퍼센트)값은 계산되고 측정 가능한 픽셀 단위로 변환됩니다.

#### 4. 페인트

- 이전 레이아웃 단계에서 계산된 값을 이용해 렌더트리의 각 노드를 화면상의 실제 픽셀로 변환합니다. 이때 위치와 관계없는 CSS 속성(색상, 투명도 등)을 적용합니다. 그리고 픽셀로 변환된 결과는 포토샵의 레이어처럼 생성되어 개별 레이어로 관리됩니다. 단, 각각의 엘리먼트가 모두 레이어가 되는 것은 아닙니다. transform 속성 등을 사용하면 엘리먼트가 레이어화 되는데, 이 과정을 페인트라고 합니다.

#### 5. 합성 & 렌더

- 페인트 단계에서 생성된 레이어를 합성하여 스크린을 업데이트합니다. 합성과 렌더 단계가 끝나면 화면에서 웹 페이지를 볼 수 있습니다.

### 레이아웃과 리페인트

- 브라우저 로딩 과정 중 스타일 이후의 과정(스타일 -> 레이아웃 -> 페인트 -> 합성)을 렌더링이라고 하는데, 이 렌더링 과정은 상황에 따라 반복하여 발생할 수 있습니다.
- 스타일 단계에서 구성되는 렌더 트리는 자바스크립트에 의해 DOM 트리, CSSOM 트리가 변경될 때 다시 재구성됩니다. DOM이 추가/삭제되거나 요소에 기하적인 영향(높이, 넓이, 위치)을 주는 CSS 속성값을 변경하는 경우, 렌더 트리가 다시 재구성됩니다. 즉, 레이아웃부터 이후 과정을 다시 수행하며 이것을 레이아웃이라고 합니다(또는 리플로우라고도 합니다).
- 레이아웃은 요소에 기하적인 영향을 주는 CSS 속성값을 변경할 때 발생한다고 하였는데, 반대로 영향을 주지 않는 CSS 속성값을 변경하면 레이아웃 과정을 건너뜁니다. 페인트부터 수행하며 이를 리페인트라고 합니다.
- 레이아웃이 일어나면 전체 픽셀을 다시 계산해야 하므로 부하가 큽니다. 반면 리페인트는 이미 계산된 픽셀값을 이용해 화면을 그리기 때문에 레이아웃에 비해 부하가 적습니다.
- 레이아웃이 발생하면 실행 시간만큼 렌더링 시간도 늘어나게 됩니다. 따라서 불필요한 레이아웃이 발생하지 않도록 신경 써야 합니다.

#### 요소에 기하적인 영향을 주는 CSS 속성값 변경

- CSS 속성값 : height, width, left, top, font-size, line-height 등

#### 요소에 기하적인 영향을 주지 않는 CSS 속성값 변경

- CSS 속성값 : background-color, color, visibility, text-decoration 등

### 블록 리소스와 주요 렌더링 경로

- 브라우저 로딩 초기 단계에서 HTML 파싱이 일어날 때 CSS 또는 자바스크립트로 인해 파싱이 중단될 수 있습니다. 이렇게 파싱이 중단되는 상황을 HTML 파싱이 블록되었다라고 표현하며, 블록 상태의 원인이 되는 리소스를 블록 리소스(Block resource) 라고 부릅니다. 블록 리소스는 브라우저 로딩 단계 중 페인트 과정을 지연시키므로, 블록 리소스가 HTML 파싱을 막는 상황이 발생하지 않도록 해야 합니다. 구글에서는 주요 렌더링 경로(Critical Rendering Path)를 최적화하면 페인팅을 빠르게 하고 로딩 속도를 개선할 수 있다고 설명합니다.

### 성능 개선 지표

#### 브라우저 기준의 성능 측정

- 전통적인 성능 측정 방식은 브라우저에서 발생하는 이벤트를 사용하는 것이었습니다. 웹 페이지가 로딩될 때 DOMContentLoaded, load 이벤트가 발생하며, 각 이벤트가 발생하는 시점으로 성능을 측정하게 됩니다.

##### DOMContentLoaded 이벤트

- HTML과 CSS 파싱이 끝나는 시점
- 렌더 트리를 구성할 준비가 된(DOM 및 CSSOM 구성이 끝난) 상황

##### load 이벤트

- HTML 상에 필요한 모든 리소스가 로드된 시점

##### 내비게이션 타이밍 API 사용

- 브라우저에서는 웹 페이지 성능을 측정할 수 있도록 내비게이션 타이밍 API를 제공합니다. 내비게이션 타이밍 API에서 PerformanceNavigationTiming의 domContentLoadedEventStart 속성을 사용하면 DOMContentLoaded 이벤트, loadEventStart 속성을 사용하면 load 이벤트의 발생 시점을 알 수 있습니다.

##### 크롬 개발자 도구 사용

- 크롬 개발자 도구는 브라우저에서 이벤트 발생 시점을 확인할 수 있도록 UI를 제공하고 다양한 측정 방법을 제공합니다. 크롬 개발자 도구를 사용하면 내비게이션 타이밍 API를 사용할 때보다 두 이벤트 간 발생 시점을 쉽게 확인할 수 있습니다.
- 그러나 개발 패러다임이 변화하면서 DOMContentLoaded, load 이벤트 발생 시점만 가지고 성능을 판단하기 어려워졌습니다. 최근에 많이 사용되는 SPA(Single Page Application)에서는 웹 페이지에 포함된 적은 양의 HTML로 DOMContentLoaded, load 이벤트가 일찍 발생할 수 있으나, 이벤트가 발생한 이후에도 수많은 스크립트 실행으로 인해 여전히 "느린 로딩"이 존재합니다. 이러한 이유로 사용자 기준의 새로운 성능 측정 방식이 필요합니다.

##### 사용자 기준의 성능 측정

- 사용자 기준의 성능 측정은 사용자에게 콘텐츠를 보여주는 여러 시점을 기반으로 합니다. 의미 있는 콘텐츠가 처음 보이는 시점이 빠를수록 성능이 좋다고 판단하며, 이 시점을 앞당길 수 있도록 최적화해야 합니다. 최적화가 잘 된 경우 0.3초에 콘텐츠 일부분이 보이고 이후 점진적으로 모든 콘텐츠가 화면에 출력됩니다. 반면 최적화가 안 된 경우 흰 화면만 보이다가 1.5초 후에 모든 콘텐츠가 보입니다. 사용자는 최적화가 잘 된 페이지를 볼 때 로딩이 더 '빠르다'고 느낀다.
  - FP(First Paint) : 흰 화면에서 화면에 무언가가 처음으로 그려지기 시작하는 순간입니다.
  - FCP(First Contentful Paint) : 텍스트나 이미지가 출력되기 시작하는 순간입니다.
  - FMP(First Meaningful Paint) : 사용자에게 의미 있는 콘텐츠가 그려지기 시작하는 첫 순간입니다. 콘텐츠를 노출하는데 필요한 CSS, 자바스크립트 로드가 시작되고 스타일이 적용되어 주요 콘텐츠를 읽을 수 있습니다.
  - TTI(Time to Interactive) : 자바스크립트의 초기 실행이 완료되어서 사용자가 직접 행동을 취할 수 있는 순간입니다.
- 이 중 가장 중요한 시점은 FMP인데, 로딩이 끝날 때까지 흰 화면 대신 의미 있는 먼저 보여주어 사용자에게 긍정적인 인상을 줄 수 있습니다. 사용자 기준에서 성능을 좋게 하기 위해서 FMP를 앞당겨야 하고, 주요 렌더링 경로를 최적화하여 해결할 수 있습니다.

### 성능 측정 도구

- 크롬 브라우저에서는 개발자 도구를 제공하며, 이 개발자 도구를 사용해 지금까지 설명한 내용을 눈으로 확인해볼 수 있습니다. 크롬 개발자 도구에서 성능과 관련된 패널로 Network, Performance, Audits가 있습니다.

#### Performance 패널

- Performance 패널에서는 웹 페이지 로딩 단계를 차트 형태로 살펴볼 수 있습니다. 웹 페이지가 로드되는 과정을 레코딩하고 단계마다 걸리는 시간을 확인할 수 있습니다. 로딩 과정에서 최적화가 필요한 부분을 찾을 때 사용합니다.

##### 영역 정보

- Controls : 레코딩을 시작하고 중단할 수 있는 영역입니다.
  - 레코딩 시작, 중단 버튼(첫 번째 버튼) : 수동으로 레코딩을 제어합니다.
  - 페이지 로드 레코딩(두 번째 버튼) : 레코드를 시작하면서 페이지를 리로드하고 완료되면 자동 중단합니다.
- Capture
  - Screenshots : 시간의 흐름에 따른 렌더링 상태를 확인할 수 있습니다.
  - Memory : Heap Memory 상태를 확인할 수 있습니다.
  - GC(가비지 컬렉션) 버튼 : 강제로 GC를 수행할 수 있습니다.
- Overview : 전체적인 흐름을 보여주는 영역입니다.
- Main : Overview에서 선택한 구간의 상세 내용을 보여주는 영역입니다.
- Details : Main에서 선택한 특정 항목의 상세 내용를 보여주는 영역입니다.

#### Network 패널

- Network 패널에서는 웹 페이지가 로딩되는 동안 요청된 리소스의 상태를 차트 형태로 확인할 수 있으며, 리소스 최적화 상태를 비교할 때 사용합니다. Performance 패널과 같이 레코딩하고, 레코딩이 끝나면 Overview와 Request Table에 리소스 요청 정보가 나타납니다. 이때 리소스 목록은 시간순으로 정렬됩니다. 그리고 차트 부분을 선택하면 각 리소스의 서버 요청 대기 시간을 자세히 볼 수 있습니다. 또한 패널 하단에 DOMContentLoaded, load 이벤트 발생 시간이 출력됩니다.

##### 영역 정보

- Controls : 네트워크 패널의 모양과 기능을 제어하는 영역입니다.
- Filters : 보여줄 리소스를 선택하는 영역입니다.
- Overview : 전체적인 요청과 다운로드 흐름을 보여주는 영역입니다.
- Request Table : 검색된 모든 리소스의 요청과 다운로드 상황을 보여주는 영역입니다.
- Summary : 총 요청 수, 전송된 데이터 양, 이벤트 로드 시간을 보여주는 영역입니다.

##### 리소스의 서버 요청 대기 시간 보기

- Queuing : 대기열에 쌓아두는 시간
  - 자바스크립트, CSS보다 우선순위가 낮아서 대기합니다.
  - TCP 소켓 대기
  - TCP 연결 초과 대기
  - 디스크 캐시 항목 작성 소요 시간
- Stalled : 요청을 보내기 전의 대기 시간
  - Queuing에서 쌓인 대기 시간 소모
  - 프락시 협상에 드는 시간
- DNS Lookup : DNS 조회에 소비된 시간
- Initial connection : TCP 핸드셰이크/재시도 및 SSL을 포함한 연결을 설정하는 데 걸린 시간
- Waiting(TTFB) : 초기 응답(Time To First Byte)을 기다리는 데 소비한 시간 (서버 왕복 시간)
- Content Download : 리소스 실제 다운로드 시간

#### Audits 패널

- Audits 패널에서는 사용자 기준의 성능 측정 지표를 확인할 수 있습니다. 화면은 크게 성능 측정 전/후로 나뉘는데, 측정 전 화면에서는 어떤 환경에서 성능을 측정할지 선택할 수 있습니다다. 느린 네트워크 환경의 시뮬레이션이 필요하다면 Throttling 영역을 설정합니다. Run audits 버튼을 클릭하면 성능 측정이 시작되며 측정 후 결과 화면을 보여줍니다.

## 참고

- [성능 최적화](https://ui.toast.com/fe-guide/ko_PERFORMANCE/#3-%EB%A0%88%EC%9D%B4%EC%95%84%EC%9B%83)
