---
title: 11장 뉴스 피드 시스템 설계
date: 2022-09-18 23:09:56
category: 가상 면접 사례로 배우는 대규모 시스템 설계 기초
tags: []
draft: true
---

- 뉴스 피드는 홈페이지 중앙에 지속적으로 업데이트되는 스토리로, 사용자 상태 정보 업데이트, 비디오, 링크, 앱 활동 등을 포함합니다.

## 개략적 설계안

### 피드 발행

- 사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 데이터베이스에 기록합니다. 새 포스팅은 친구와 뉴스 피드에도 전송됩니다.

| 구분                               | 설명                                                                                                                |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------- |
| 사용자                             | 모바일 앱이나 브라우저에서 새 포스팅을 올리는 주체입니다                                                            |
| 로드밸런서(load balancer)          | 트래픽을 웹 서버들로 분산합니다                                                                                     |
| 웹 서버                            | HTTP 요청을 내부 서비스로 중계하는 역할을 담당합니다                                                                |
| 포스팅 저장 서비스(post service)   | 새 포스팅을 데이터베이스와 캐시에 저장합니다                                                                        |
| 포스팅 전송 서비스(fanout service) | 새 포스팅을 친구의 뉴스 피드에 푸시(push)합니다. 뉴스 피드 데이터는 캐시에 보관하여 빠르게 읽어갈 수 있도록 합니다. |
| 알림 서비스(notification service)  | 친구들에게 새 포스팅이 올라왔음을 알리거나, 푸시 알림을 보내는 역할을 담당합니다                                    |

### 뉴스 피드 생성

- 지면 관계상 뉴스 피드는 모든 친구의 포스팅을 시간 흐름 역순으로 모아서 만든다고 가정합니다.

| 구분                                | 설명                                                |
| ----------------------------------- | --------------------------------------------------- |
| 사용자                              | 뉴스 피드를 읽는 주체입니다                         |
| 로드 밸런서                         | 트래픽을 웹 서버들로 분산합니다                     |
| 웹 서버                             | 트래픽을 뉴스 피드 서비스로 보냅니다                |
| 뉴스 피드 서비스(news feed service) | 캐시에서 뉴스 피드를 가져오는 서비스입니다          |
| 뉴스 피드 캐시(news feed cache)     | 뉴스 피드를 렌더링할 때 필요한 피드 ID를 보관합니다 |

## 상세 설계

| 구분                       | 설명                                                                                                                                                                         |
| -------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 웹 서버                    | 웹 서버는 클라이언트와 통신할 뿐 아니라 인증이나 처리율 제한 등의 기능도 수행합니다                                                                                          |
| 포스팅 전송(팬아웃) 서비스 | 팬아웃에는 두 가지 모델이 있는데 하나는 쓰기 시점에 팬아웃(fanout-on-write)하는 모델이고(푸시 모델), 다른 하나는 읽기 시점에 팬아웃(fanout-on-read)하는 모델(풀 모델)입니다. |

### 쓰기 시점에 팬아웃하는 모델

- 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신하게 됩니다.
- 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록합니다.

#### 장점

- 뉴스 피드가 실시간으로 갱신되며 친구 목록에 있는 사용자에게 즉시 전송됩니다.
- 새 포스팅이 기록되는 순간에 뉴스 피드가 이미 갱신되므로(precomputed) 뉴스 피드를 읽는 데 드는 시간이 짧아집니다.

#### 단점

- 친구가 많은 사용자의 경우 친구 목록을 가져오고 그 목록에 있는 사용자 모두의 뉴스 피드를 갱신하는 데 많은 시간이 소요될 수도 있습니다. 핫키(hotkey)라고 부르는 문제입니다.
- 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야 하므로 컴퓨팅 자원이 낭비됩니다.

### 읽기 시점에 팬아웃하는 모델

- 피드를 읽어야 하는 시점에 뉴스 피드를 갱신합니다.
- 요청기반(on-demand) 모델입니다.

#### 장점

- 비활성화된 사용자, 또는 서비스에 거의 로그인하지 않는 사용자의 경우에는 이 모델이 유리합니다. 로그인하기까지는 어떤 컴퓨팅 자원도 소모하지 않습니다.
- 데이터를 친구 각각에 푸시하는 작업이 필요 없으므로 핫키 문제도 생기지 않습니다.

#### 단점

- 뉴스 피드를 읽는 데 많은 시간이 소요될 수 있습니다.

### 캐시 구조

| 구분          | 설명                                                                                                      |
| ------------- | --------------------------------------------------------------------------------------------------------- |
| 뉴스 피드     | 뉴스 피드의 ID를 보관합니다                                                                               |
| 콘텐츠        | 포스팅 데이터를 보관합니다. 인기 콘텐츠는 따로 보관합니다                                                 |
| 소셜 그래프   | 사용자 간 관계 정보를 보관합니다                                                                          |
| 행동(action)  | 포스팅에 대한 사용자의 행위에 관한 정보를 보관합니다. 포스팅에 대한 '좋아요', 답글 등등이 이에 해당합니다 |
| 횟수(counter) | '좋아요' 횟수, 응답 수, 팔로어 수, 팔로잉 수 등의 정보를 보관합니다                                       |

## 마무리

### 데이터베이스 규모 확장

- 수작적 규모 확장 vs 수평적 규모 확장
- SQL vs NoSQL
- 주-부(master-slave) 다중화
- 복제본(replica)에 대한 읽기 연산
- 일관성 모델(consistency model)
- 데이터베이스 샤딩(sharding)

### 논의해 보면 좋을 만한 주제

- 웹 계층(web tier)을 무상태로 운영하기
- 가능한 한 많은 데이터를 캐시할 방법
- 여러 데이터 센터를 지원할 방법
- 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기
- 핵심 메트릭(key metric)에 대한 모니터링
  - 트래픽이 몰리는 시간대의 QPS(Queries per Seconde)
  - 사용자가 뉴스 피드를 새로고침(refresh) 할 때의 지연시간

---

## 참고

- [가상 면접 사례로 배우는 대규모 시스템 설계 기초](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9788966263158)
