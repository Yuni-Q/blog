---
title: CHAPTER7. 신뢰할 수 없는 코드를 쓰면서 불변성 지키기
date: 2023-03-12 14:03:12
category: 쏙쏙 들어오는 함수형 코딩
tags: ['PART I 액션과 계산, 데이터']
draft: true
---

## 이번 장에서 살펴볼 내용

- 레거시 코드나 신회할 수 없는 코드로부터 내 코드를 보호하기 위해 방어적 복사를 만듭니다.
- 얕은 복사와 깊은 복사를 비교합니다.
- 카피-온-라이트와 방어적 복사를 언제 사용하면 좋은지 알 수 있습니다.

## 방어적 복사 규칙

- 방어적 복사는 데이터를 변경할 수도 있는 코드와 불변성 코드 사이에 데이터를 주고받기 위한 원칙입니다.

### 규칙1: 데이터가 안전한 코드에서 나갈 때 복사하기

### 규칙2: 안전한 코드로 데이터가 들어올 때 복사하기

## 쉬는 시간

- 동시에 사용자 데이터 복사본 두 개가 있어도 문제가 없나요?
  - 데이터는 이벤트에 대한 사실입니다. 입력 폼을 전송했다는 이벤트에 대한 사용자의 이름과 같은 사실을 기록합니다.
- 카피-온-라이트와 방어적 복사는 비슷할거 같아요.
  - 방어적 복사는 깊은 복사를 합니다.

## 카피-온-라이트와 방어적 복사를 비교해 봅시다

| 구분           | 카피-온-라이트                                                                                     | 방어적복사                                                                                                       |
| -------------- | -------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| 언제쓰나요?    | 통제할 수 있는 데이터를 바꿀 때 카피-온-라이트를 씁니다                                            | 신뢰할 수 없는 코드와 데이터를 주고받아야 할 때 방어적 복사를 씁니다                                             |
| 어디서 쓰나요? | 안전지대 어디서나 쓸 수 있습니다. 사실 카피-온-라이트가 불변성을 가진 안전지대를 만듭니다          | 안전지대의 경계에서 데이터가 오고 갈 때 방어적 복사를 씁니다                                                     |
| 복사 방식      | 얕은 복사(상대적으로 비용이 적게 듭니다)                                                           | 깊은 복사(상대적으로 비용이 많이 듭니다)                                                                         |
| 규칙           | 1. 바꿀 데이터의 얕은 복사를 만듭니다. <br/> 2. 복사본을 변경합니다. <br/> 3. 복사본을 리턴합니다. | 1. 안전지대로 들어오는 데이터에 깊은 복사를 만듭니다. <br/> 2. 안전지대에서 나가는 데이터에깊은 복사를 만듭니다. |

## 요점 정리

- 방어적 복사는 불변성을 구현하는 원칙입니다. 데이터가 들어오고 나갈 때 복사본을 만듭니다.
- 방어적 복사는 깊은 복사를 합니다. 그래서 카피-온-라이트보다 비용이 더 듭니다.
- 카피-온-라이트와 다르게 방ㅇ어적 복사는 불변성 원칙을 구현하지 않은 코드로부터 데이터를 보호해 줍니다.
- 복사본이 많이 필요하지 않기 때문에 카피-온-라이트를 더 많이 사용합니다. 방어적 복사는 신뢰할 수 없는 코드와 함께 사용할 때만 사용합니다.
- 깊은 복사는 위에서 아래로 중첩된 데이터 전체를 복사합니다. 얕은 복사는 필요한 부분만 최소한으로 복사합니다.

---

## 참고

- [쏙쏙 들어오는 함수형 코딩](https://product.kyobobook.co.kr/detail/S000001952246)
