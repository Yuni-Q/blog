---
title: 15장 구글 드라이브 설계
date: 2022-10-02 01:10:51
category: 가상 면접 사례로 배우는 대규모 시스템 설계 기초
tags: []
draft: true
---

## 동기화 충돌

- 먼저 처리되는 변경은 성공한 것으로 보고, 나중에 처리되는 변경은 충돌이 발생한 것으로 표시합니다.

## 블록 저장소 서버

- 정기적으로 갱신되는 큰 파일들은 업데이트가 일어날 때마다 전체 파일을 서버로 보내면 네트워크 대역폭을 많이 잡아먹게 됩니다.
- 최적화하는 방법
  - 델타 동기화: 파일이 수정되면 전체 파일 대신 수정이 일어난 블록만 동기화합니다.
  - 압축: 블록 단위로 압축해 두면 데이터 크기를 많이 줄일 수 있습니다.
- 클라이언트가 보낸 파일을 블록 단위로 나눠야 하고, 각 블록에 압축 알고리즘을 적용해야 하고, 암호화까지 해야 합니다. 아울러 전체 파일을 저장소 시스템으로 보내는 대신 수정된 블록만 전송해야 합니다.

## 높은 일관성 요구사항

- 메모리 캐시는 보통 최종 일관성(eventual consistency) 모델을 지원합니다.
- 강한 일관성을 달성하려면 다음 사항을 보장해야 합니다.
  - 캐시에 보관된 사본과 데이터베이스에 있는 우너본이 일치합니다.
  - 데이터베이스에 보관된 원본에 변경이 발생하면 캐시에 있는 사본을 무효화합니다.
- 관계형 데이터베이스는 ACID(Atomicity, Consistency, Isolation, Durability)를 보장하므로 강한 일관성을 보장하기 쉽습니다. 하지만 NoSQL 데이터베이스는 이를 기본으로 지원하지 않으므로, 동기화 로직 안에 프로그램해 넣어야 합니다.

## 알림 서비스

- 파일의 일관성을 유지하기 위해, 클라이언트는 로컬에서 파일이 수정되었음을 감지하는 순간 다른 클라이언트에 그 사실을 알려서 충돌 가능성을 줄여야 합니다. 단순하게 보자면 알림 서비스는 이벤트 데이터를 클라이언트로 보내는 서비스입니다.
- 웹소켓보다 롱 폴링을 이용합니다.
  - 채팅 서비스와는 달리, 본 시스템의 경우에는 알림 서비스와 양방향 통신이 필요하지 않습니다. 서버는 파일이 변경된 사실을 클라이언트에게 알려주어야 하지만 반대 방향의 통신은 요구되지 않습니다.

## 저장소 공간 절약

- 중복 제거
- 지능적 백업 전략 도입
  - 한도 설정
  - 중요한 버전만 보관
- 자주 쓰이지 않는 데이터 아카이빙

## 장애처리

- 로드밸런서 장애
- 블록 저장소 서버 장애
- 클라우드 저장소 장애
- API 서버 장애
- 메타데이터 캐시 장애
- 메타데이터 데이터베이스 장애
- 알림 서비스 장애
- 오프라인 사용자 백업 큐 장애

## 블록 저장소 서버를 거치지 않고 파일을 클라우드 저장소에 직접 업로드

### 장점

- 업로드 시간이 빨라집니다.

### 단점

- 분할, 압축, 암호화 로직을 클라이언트에 두어야 하므로 플랫폼별로 따로 구현해야 합니다.
- 클라이언트가 해킹 당할 가능성이 있으므로 암호화 로직을 클라이언트 안에 두는 것은 적절치 않은 선택일 수 있습니다.

---

## 참고

- [가상 면접 사례로 배우는 대규모 시스템 설계 기초](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9788966263158)
