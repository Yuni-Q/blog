---
title: 13장 검색어 자동완성 시스템
date: 2022-09-27 21:09:60
category: 가상 면접 사례로 배우는 대규모 시스템 설계 기초
tags: []
draft: true
---

- 검색어 자동완성(autocomplete, typeahead, search-as-you-type, incremental search)이라 부릅니다.

## 요구사항

- 빠른 응답 속도
- 연관성
- 정렬
- 규모의 확장
- 고가용성

## 개략적 설계안

- 데이터 수집 서비스(data gathering service)
- 질의 서비스(query service)

### 질의 서비스

- query: 질의문을 저장하는 필드
- frequency: 질의문이 사용되는 빈도를 저장하는 필드

## 상세 설계

- 트라이(trie) 자료구조
- 데이터 수집 서비스
- 질의 서비스
- 규모 확장이 가능한 저장소
- 트라이 연산

### 트라이 자료 구조

- 트라이(trie, 접두어 트리(prefix tree)라고도 합니다)를 사용해 해결합니다.
- 트라이는 무자열들을 간략하게 저장할 수 있는 자료구조입니다. 트라이라는 이름은 'retrieval'이라는 단어에서 온 것인데, 문자열을 꺼내는 연산에 초점을 찾추어 설계된 자료구조임을 미루어 짐작할 수 있습니다.
- 트라이는 트리 형태의 자료구조입니다.
- 이 트리의 루트 노드는 빈 문자열을 나타냅니다.
- 각 노드는 글자(character) 하나를 저자아혐, 26개(해당 글자 다음에 등장할 수 있는 모든 글자의 개수)의 자식 노드를 가질 수 있습니다.
- 각 트리 노드는 하나의 단어, 또는 접두어 문자열을 나타냅니다.
- 기본 트라이 자료구조는 노드에 문자들을 저장합니다. 이용 빈도에 따라 정렬된 결과를 내호기 위해서는 노드에 빈도 정보까지 저장할 필요가 있습니다.

#### 구현

##### 정의

- p: 접두어(prefix)의 길이
- n: 트라이 안에 있는 노드 개수
- c: 주어진 노드의 자식 노드 개수

##### 가장 많이 사용된 질의어 k개 찾기

- 해당 접두어를 표현하는 노드를 찾습니다. 시간 복장도는 O(p)입니다.
- 해당 노드부터 싲가하는 하위 트리를 탐색하여 모든 유효 노드를 찾습니다. 유효한 검색 문자영ㄹ 구성하는 노드가 유효 노드입니다. 시간 복잡도는 O(c)입니다.
- 유효 노드들을 정렬하여 가장 인기 있는 검색어 k개를 찾습ㄴ디ㅏ. 시간 복잡도는 (O(clogc))입니다.

##### 문제점 해결 방법

- 접두어의 최대 길이를 제한
  - 검색어으 ㅣ초대 길이를 제한할 수 있다면 '접두어 노드를 찾는' 단계의 시간 복잡도는 O(p)에서 O(작은 상숫값) = O(1)로 바뀔 것입니다.
- 각 노드에 인기 검색어를 캐시
  - 각 노드에 질의어를 저장할 공간이 많이 필요하게 된다는 단점도 있지만 빠른 응답속도가 아주 중요할 때는 이 정도 저장공간을 희생할 만한 가치는 있습니다.

##### 결과

- 접두어 노드를 찾는 시간 복잡도는 O(1)로 바뀝니다.
- 최고 인기 검색어 5개를 찾는 질의의 시간 복잡도도 O(1)로 바뀝니다. 검색 결과가 이미 캐시되어 있어서 입니다.

### 질의 서비스 최적화 방법

- AJAX 요청
- 브라우저 캐싱
- 데이터 샘플링

### 트라이 갱신 방법

- 매주 한 번 갱신하는 방법
- 트라이의 각 노드를 개별적으로 갱신하는 방법
  - 트라이가 작을때는 고려해봄직합니다.

## 마무리

- 다국어 지원을 위해서는 트라이에 유니콯드 데이터를 저장해야 합니다.
- 국가별로 인기 검색어 순위가 다르다면 트라이를 CDN에 저장하여 응답속드를 높이는 방법도 생각해 볼 수 있습니다.
- 실시간 검색어 자동완성 시스템을 구축하기 위해서는 샤딩을 통해여 작업 대상 데이터를 줄이고, 순위 모델(ranking model)를 바꾸어 최근 검색어에 보다 높은 가중치를 주고, 데이터가 스트림 형태로 올 수 있는 점, 즉 한번에 모든 데이터를 동시에 사용할 수 없을 가능성이 있다는 점을 고려해야 합니다.

---

## 참고

- [가상 면접 사례로 배우는 대규모 시스템 설계 기초](http://www.kyobobook.co.kr/product/detailViewKor.laf?mallGb=KOR&ejkGb=KOR&barcode=9788966263158)
